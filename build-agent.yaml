apiVersion: v1
kind: Pod
metadata:
  name: build-agent
  namespace: ci
  labels:
    app: spring-build-ci
spec:
  containers:
    - name: maven
      image: maven:alpine
      command:
        - cat
      tty: true
      volumeMounts:
        - name: m2
          mountPath: /root/.m2/
    - name: docker-tools
      image: rmkanda/docker-tools:latest
      command:
        - cat
      tty: true
      volumeMounts:
        - mountPath: /var/run
          name: docker-sock
        - mountPath: /tmp/trivycache/
          name: trivycache
#    - name: buildkitd
#      image: moby/buildkit:master-rootless
#      args:
#         - --addr
#         - unix:///run/user/1000/buildkit/buildkitd.sock
#         - --addr
#         - tcp://0.0.0.0:1234
#         - --tlscacert
#         - /certs/ca.pem
#         - --tlscert
#         - /certs/cert.pem
#         - --tlskey
#         - /certs/key.pem
#         - --oci-worker-no-process-sandbox
#      # the probe below will only work after Release v0.6.3
#      readinessProbe:
#        exec:
#          command:
#            - buildctl
#            - debug
#            - workers
#        initialDelaySeconds: 5
#        periodSeconds: 30
#      # the probe below will only work after Release v0.6.3
#      livenessProbe:
#        exec:
#          command:
#            - buildctl
#            - debug
#            - workers
#        initialDelaySeconds: 5
#        periodSeconds: 30
#      securityContext:
#        # Needs Kubernetes >= 1.19
#        seccompProfile:
#          type: Unconfined
#        # Needs Kubernetes >= 1.30
#        appArmorProfile:
#          type: Unconfined
#        # To change UID/GID, you need to rebuild the image
#        runAsUser: 1000
#        runAsGroup: 1000
#      ports:
#        - containerPort: 1234
#      volumeMounts:
#        - name: certs
#          readOnly: true
#          mountPath: /certs
#        # Dockerfile has `VOLUME /home/user/.local/share/buildkit` by default too,
#        # but the default VOLUME does not work with rootless on Google's Container-Optimized OS
#        # as it is mounted with `nosuid,nodev`.
#        # https://github.com/moby/buildkit/issues/879#issuecomment-1240347038
#        - name: buildkitd
#          mountPath: /home/user/.local/share/buildkit
#        - name: jenkins-docker-cfg
#          mountPath: /home/user/.docker
    - name: trufflehog
      image: rmkanda/trufflehog
      command:
        - cat
      tty: true
    - name: licensefinder
      image: licensefinder/license_finder
      command:
        - cat
      tty: true
  volumes:
    - name: m2
      hostPath:
        path: /tmp/.m2/
    - name: docker-sock
      hostPath:
        path: /var/run
    - name: trivycache
      hostPath:
        path: /tmp/trivycache/
#    - name: certs
#      secret:
#        secretName: buildkit-daemon-certs
#    - name: buildkitd
#      emptyDir: {}
    - name: jenkins-docker-cfg
      projected:
        sources:
        - secret:
            name: regcred
            items:
            - key: .dockerconfigjson
              path: config.json
      

